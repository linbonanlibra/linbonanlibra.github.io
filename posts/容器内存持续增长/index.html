<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta name="theme-color" media="(prefers-color-scheme: light)" content="#f7f7f7">
<meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1b1b1e">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="viewport" content="width=device-width, user-scalable=no initial-scale=1, shrink-to-fit=no, viewport-fit=cover">
<meta name="generator" content="Jekyll v4.4.1">
<meta property="og:title" content="模型服务器内存持续下降问题排查">
<meta property="og:locale" content="en">
<meta name="description" content="尝试用 valgrind 分析内存 考虑先尝试定位出 Native 内存到底被什么占用了、是什么申请了内存却没及时释放，最初想用 valgrind 抓一下内存的分配/释放动作，来分析是什么被遗留在了内存里没释放。 但在机器上安装好环境后发现，它要有一个可执行文件才比较便于分析，对于 jvm，它不太好使用。但脱离了jvm，单独把模型加载代码抽出来又感觉不能很好的还原场景。 1 2 3 yum install valgrind valgrind --leak-check=full --show-leak-kinds=all --suppressions=suppression_file --log-file=valgrind_with_suppression.log -v java &lt;Java Class&gt; valgrind --leak-check=full --show-leak-kinds=all -v java">
<meta property="og:description" content="尝试用 valgrind 分析内存 考虑先尝试定位出 Native 内存到底被什么占用了、是什么申请了内存却没及时释放，最初想用 valgrind 抓一下内存的分配/释放动作，来分析是什么被遗留在了内存里没释放。 但在机器上安装好环境后发现，它要有一个可执行文件才比较便于分析，对于 jvm，它不太好使用。但脱离了jvm，单独把模型加载代码抽出来又感觉不能很好的还原场景。 1 2 3 yum install valgrind valgrind --leak-check=full --show-leak-kinds=all --suppressions=suppression_file --log-file=valgrind_with_suppression.log -v java &lt;Java Class&gt; valgrind --leak-check=full --show-leak-kinds=all -v java">
<link rel="canonical" href="https://linbonanlibra.github.io/posts/%E5%AE%B9%E5%99%A8%E5%86%85%E5%AD%98%E6%8C%81%E7%BB%AD%E5%A2%9E%E9%95%BF/">
<meta property="og:url" content="https://linbonanlibra.github.io/posts/%E5%AE%B9%E5%99%A8%E5%86%85%E5%AD%98%E6%8C%81%E7%BB%AD%E5%A2%9E%E9%95%BF/">
<meta property="og:site_name" content="24601">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2022-05-12T18:06:00+08:00">
<meta name="twitter:card" content="summary">
<meta property="twitter:title" content="模型服务器内存持续下降问题排查"> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2022-05-12T18:06:00+08:00","datePublished":"2022-05-12T18:06:00+08:00","description":"尝试用 valgrind 分析内存 考虑先尝试定位出 Native 内存到底被什么占用了、是什么申请了内存却没及时释放，最初想用 valgrind 抓一下内存的分配/释放动作，来分析是什么被遗留在了内存里没释放。 但在机器上安装好环境后发现，它要有一个可执行文件才比较便于分析，对于 jvm，它不太好使用。但脱离了jvm，单独把模型加载代码抽出来又感觉不能很好的还原场景。 1 2 3 yum install valgrind valgrind --leak-check=full --show-leak-kinds=all --suppressions=suppression_file --log-file=valgrind_with_suppression.log -v java &lt;Java Class&gt; valgrind --leak-check=full --show-leak-kinds=all -v java","headline":"模型服务器内存持续下降问题排查","mainEntityOfPage":{"@type":"WebPage","@id":"https://linbonanlibra.github.io/posts/%E5%AE%B9%E5%99%A8%E5%86%85%E5%AD%98%E6%8C%81%E7%BB%AD%E5%A2%9E%E9%95%BF/"},"url":"https://linbonanlibra.github.io/posts/%E5%AE%B9%E5%99%A8%E5%86%85%E5%AD%98%E6%8C%81%E7%BB%AD%E5%A2%9E%E9%95%BF/"}</script><title>模型服务器内存持续下降问题排查 | 24601</title>
<link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png">
<link rel="manifest" href="/assets/img/favicons/site.webmanifest">
<link rel="shortcut icon" href="/assets/img/favicons/favicon.ico">
<meta name="apple-mobile-web-app-title" content="24601">
<meta name="application-name" content="24601">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml">
<meta name="theme-color" content="#ffffff">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="dns-prefetch" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link rel="dns-prefetch" href="https://fonts.gstatic.com">
<link rel="preconnect" href="https://cdn.jsdelivr.net">
<link rel="dns-prefetch" href="https://cdn.jsdelivr.net">
<link rel="stylesheet" href="/assets/css/jekyll-theme-chirpy.css">
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400&amp;family=Source+Sans+Pro:wght@400;600;700;900&amp;display=swap">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lxgw-wenkai-screen-web/style.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@7.1.0/css/all.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tocbot@4.36.4/dist/tocbot.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/glightbox@3.3.0/dist/css/glightbox.min.css"> <script src="/assets/js/dist/theme.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js,npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.umd.min.js,npm/glightbox@3.3.0/dist/js/glightbox.min.js,npm/clipboard@2.0.11/dist/clipboard.min.js,npm/dayjs@1.11.18/dayjs.min.js,npm/dayjs@1.11.18/locale/en.js,npm/dayjs@1.11.18/plugin/relativeTime.js,npm/dayjs@1.11.18/plugin/localizedFormat.js,npm/tocbot@4.36.4/dist/tocbot.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script defer src="/app.min.js?baseurl=&amp;register=true"></script>
</head>
<body>
<aside aria-label="Sidebar" id="sidebar" class="d-flex flex-column align-items-end"><header class="profile-wrapper"> <a href="/" id="avatar" class="rounded-circle"><img src="/assets/img/avatar/avatar.png" width="112" height="112" alt="avatar" onerror="this.style.display='none'"></a> <a class="site-title d-block" href="/">24601</a><p class="site-subtitle fst-italic mb-0">-- rua rua rua --</p></header><nav class="flex-column flex-grow-1 w-100 ps-0"><ul class="nav">
<li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home"></i> <span>HOME</span> </a>
</li>
<li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream"></i> <span>CATEGORIES</span> </a>
</li>
<li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags"></i> <span>TAGS</span> </a>
</li>
<li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive"></i> <span>ARCHIVES</span> </a>
</li>
<li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle"></i> <span>ABOUT</span> </a>
</li>
</ul></nav><div class="sidebar-bottom d-flex flex-wrap align-items-center w-100"> <button type="button" class="btn btn-link nav-link" aria-label="Switch Mode" id="mode-toggle"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/linbonanlibra" aria-label="github" target="_blank" rel="noopener noreferrer"> <i class="fab fa-github"></i> </a> <a href="javascript:location.href%20=%20'mailto:'%20+%20['929lbn','163.com'].join('@')" aria-label="email"> <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss"> <i class="fas fa-rss"></i> </a>
</div></aside><div id="main-wrapper" class="d-flex justify-content-center">
<div class="container d-flex flex-column px-xxl-5">
<header id="topbar-wrapper" class="flex-shrink-0" aria-label="Top Bar"><div id="topbar" class="d-flex align-items-center justify-content-between px-lg-3 h-100">
<nav id="breadcrumb" aria-label="Breadcrumb"> <span> <a href="/">Home</a> </span> <span>模型服务器内存持续下降问题排查</span></nav><button type="button" id="sidebar-trigger" class="btn btn-link" aria-label="Sidebar"> <i class="fas fa-bars fa-fw"></i> </button><div id="topbar-title"> Post</div>
<button type="button" id="search-trigger" class="btn btn-link" aria-label="Search"> <i class="fas fa-search fa-fw"></i> </button> <search id="search" class="align-items-center ms-3 ms-lg-0"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </search> <button type="button" class="btn btn-link text-decoration-none" id="search-cancel">Cancel</button>
</div></header><div class="row flex-grow-1">
<main aria-label="Main Content" class="col-12 col-lg-11 col-xl-9 px-md-4"><article class="px-1" data-toc="true"><header><h1 data-toc-skip>模型服务器内存持续下降问题排查</h1>
<div class="post-meta text-muted"> <span> Posted <time data-ts="1652349960" data-df="ll" data-bs-toggle="tooltip" data-bs-placement="bottom"> May 12, 2022 </time> </span><div class="d-flex justify-content-between"> <span> By <em> <a href="https://github.com/linbonanlibra">linbonanlibra</a> </em> </span><div> <span class="readtime" data-bs-toggle="tooltip" data-bs-placement="bottom" title="1840 words"> <em>10 min</em> read</span>
</div>
</div>
</div></header><div id="toc-bar" class="d-flex align-items-center justify-content-between invisible"> <span class="label text-truncate">模型服务器内存持续下降问题排查</span> <button type="button" class="toc-trigger btn me-1"> <i class="fa-solid fa-list-ul fa-fw"></i> </button>
</div>
<button id="toc-solo-trigger" type="button" class="toc-trigger btn btn-outline-secondary btn-sm"> <span class="label ps-2 pe-1">Contents</span> <i class="fa-solid fa-angle-right fa-fw"></i> </button> <dialog id="toc-popup" class="p-0"><div class="header d-flex flex-row align-items-center justify-content-between">
<div class="label text-truncate py-2 ms-4">模型服务器内存持续下降问题排查</div>
<button id="toc-popup-close" type="button" class="btn mx-1 my-1 opacity-75"> <i class="fas fa-close"></i> </button>
</div>
<div id="toc-popup-content" class="px-4 py-3 pb-4"></div></dialog><div class="content">
<h2 id="尝试用-valgrind-分析内存">
<span class="me-2">尝试用 valgrind 分析内存</span><a href="#%E5%B0%9D%E8%AF%95%E7%94%A8-valgrind-%E5%88%86%E6%9E%90%E5%86%85%E5%AD%98" class="anchor text-muted"><i class="fas fa-hashtag"></i></a>
</h2>
<p>考虑先尝试定位出 Native 内存到底被什么占用了、是什么申请了内存却没及时释放，最初想用 valgrind 抓一下内存的分配/释放动作，来分析是什么被遗留在了内存里没释放。 但在机器上安装好环境后发现，它要有一个可执行文件才比较便于分析，对于 jvm，它不太好使用。但脱离了jvm，单独把模型加载代码抽出来又感觉不能很好的还原场景。</p>
<div class="language-shell highlighter-rouge">
<div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button>
</div>
<div class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td>
<td class="rouge-code"><pre>yum <span class="nb">install </span>valgrind
valgrind <span class="nt">--leak-check</span><span class="o">=</span>full <span class="nt">--show-leak-kinds</span><span class="o">=</span>all <span class="nt">--suppressions</span><span class="o">=</span>suppression_file <span class="nt">--log-file</span><span class="o">=</span>valgrind_with_suppression.log <span class="nt">-v</span> java &lt;Java Class&gt;
valgrind <span class="nt">--leak-check</span><span class="o">=</span>full <span class="nt">--show-leak-kinds</span><span class="o">=</span>all <span class="nt">-v</span> java
</pre></td>
</tr></tbody></table></code></div>
</div>
<h2 id="尝试用-jemalloc-分析内存">
<span class="me-2">尝试用 jemalloc 分析内存</span><a href="#%E5%B0%9D%E8%AF%95%E7%94%A8-jemalloc-%E5%88%86%E6%9E%90%E5%86%85%E5%AD%98" class="anchor text-muted"><i class="fas fa-hashtag"></i></a>
</h2>
<p>另一个思路是，尝试将内存分配管理交给jemalloc来做，因为它自带一个prof工具，可以分析内存情况。 参考 https://chenhm.com/post/2018-12-05-debuging-java-memory-leak 和 20210409 kms server内存占用高</p>
<p>在测试机器上安装环境，尝试如下配置后重启机器</p>
<div class="language-shell highlighter-rouge">
<div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button>
</div>
<div class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td>
<td class="rouge-code"><pre><span class="nb">export </span><span class="nv">LD_PRELOAD</span><span class="o">=</span>/usr/lib64/libjemalloc.so
<span class="nb">export </span><span class="nv">MALLOC_CONF</span><span class="o">=</span>prof:true,lg_prof_sample:1,lg_prof_interval:26,prof_prefix:/opt/logs/com.sankuai.qcs.service.modelserver/heap/jeprof.out
./jeprof <span class="nt">--show_bytes</span> <span class="nt">-svg</span> /usr/local/java/bin/java  /jeprof.<span class="k">*</span>.heap <span class="o">&gt;</span> ms-jeprof.svg
</pre></td>
</tr></tbody></table></code></div>
</div>
<p>启动时的 heap dump prof 图如下，没看到明显的来自jvm的大占用，反倒是启动后直接把 mem.free.percent 打到 20%了，触发多次模型重载后甚至导致机器 OOM <a href="/assets/img/attachments/modelserverHeapDump.png" class="popup img-link shimmer"><img src="/assets/img/attachments/modelserverHeapDump.png" alt="img" loading="lazy"></a> 里怀疑是 prof 的参数配置的有问题，导致监控成本过高，损害了系统运行(yum install 时是无法开启prof的，要靠源码手动编译时增加参数来开启prof能力，因此怀疑这个功能对性能影响会比较大？)。 虽然尝试变更了几次 prof参数都没能抓到理想的 dump 数据，但在了解 jemalloc 时有了一个新思路，会不会是 glibc 的内存管理特点，导致了内存没被及时还给系统？</p>
<h2 id="glibc-内存碎片">
<span class="me-2">glibc 内存碎片</span><a href="#glibc-%E5%86%85%E5%AD%98%E7%A2%8E%E7%89%87" class="anchor text-muted"><i class="fas fa-hashtag"></i></a>
</h2>
<p>查了一些关于 glibc 内存分配的介绍，越发怀疑可能是内存碎片的问题。</p>
<blockquote><p>进程向 OS 申请和释放地址空间的接口 sbrk/mmap/munmap 都是系统调用，频繁调用系统调用都比较消耗系统资源的。而且， mmap 申请的内存被 munmap 后，从新申请会产生更多的缺页中断。例如使用 mmap 分配 1M 空间，第一次调用产生了大量缺页中断 (1M/4K 次 ) ，当munmap 后再次分配 1M 空间，会再次产生大量缺页中断。缺页中断是内核行为，会致使内核态CPU消耗较大。另外，若是使用 mmap 分配小内存，会致使地址空间的分片更多，内核的管理负担更大。 同时堆是一个连续空间，而且堆内碎片因为没有归还 OS ，若是可重用碎片，再次访问该内存极可能不需产生任何系统调用和缺页中断，这将大大下降 CPU 的消耗。 所以， glibc 的 malloc 实现中，充分考虑了 sbrk 和 mmap 行为上的差别及优缺点，默认分配大块内存 (128k) 才使用 mmap 得到地址空间，也可经过 mallopt(M_MMAP_THRESHOLD, <size>) 来修改这个临界值。</size></p></blockquote>
<p>还在 openjdk 里翻到了一个关于「通过 jcmd命令主动触发trim内存」(收缩内存？)的讨论 https://bugs.openjdk.java.net/browse/JDK-8269345</p>
<p>看了下他们最终对该指令的代码实现 https://github.com/openjdk/jdk17u/commit/d93500168cd120165fedb9609fdf2e10458976dd?diff=split, 可以看到命令的实现方法在下图，而这个方法里，除去执行前后的信息统计，真正的逻辑只有一句，malloc_trim(0)。 <a href="/assets/img/attachments/malloc_trim_source_code.png" class="popup img-link shimmer"><img src="/assets/img/attachments/malloc_trim_source_code.png" alt="img" loading="lazy"></a> 这是 Glibc 的一个方法 https://github.com/lattera/glibc/blob/master/malloc/malloc.h <a href="/assets/img/attachments/glibc_malloc_trim.png" class="popup img-link shimmer"><img src="/assets/img/attachments/glibc_malloc_trim.png" alt="img" loading="lazy"></a></p>
<p>在测试机器上先重复加载模型，让 mem.free.percent 出现明显下跌，然后登陆机器，切换到 root 权限后 执行 sudo gdb -p 5331 -batch -ex ‘call malloc_trim(0)’ ，通过gdb来调用一次 malloc_trim 函数。 反复几次，可以看到每次执行trim函数后，内存都会明显得到释放。至此，大概率确定是 glibc 内存分配策略下，内存碎片导致的问题</p>
<h2 id="临时解决方案">
<span class="me-2">临时解决方案</span><a href="#%E4%B8%B4%E6%97%B6%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88" class="anchor text-muted"><i class="fas fa-hashtag"></i></a>
</h2>
<p>考虑通过 jni 的方式实现在 jvm 内主动调用 malloc_trim 函数实现对C库缓存的内存的回收。由于我们除了调用该函数外并不需要增加其他自定义的逻辑，因此可以考虑直接利用 JNA 实现。</p>
<div class="language-plaintext highlighter-rouge">
<div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button>
</div>
<div class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td>
<td class="rouge-code"><pre>glic 2.7 malloc.c 源码 https://elixir.bootlin.com/glibc/glibc-2.17/source/malloc/malloc.c 
glic 2.7 malloc.h https://github.com/apc-llc/glibc-2.17/blob/master/malloc/malloc.h
jna 源码 https://github.com/java-native-access/jna
jna 示例 https://www.eshayne.com/jnaex/index.html?example=4
</pre></td>
</tr></tbody></table></code></div>
</div>
<div class="language-java highlighter-rouge">
<div class="code-header"> <span data-label-text="Java"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button>
</div>
<div class="highlight"><code><table class="rouge-table"><tbody><tr>
<td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
</pre></td>
<td class="rouge-code"><pre><span class="kn">import</span> <span class="nn">com.sun.jna.Library</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.sun.jna.Native</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.sun.jna.Structure</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">GLibcLibrary</span> <span class="kd">extends</span> <span class="nc">Library</span> <span class="o">{</span>

    <span class="kd">static</span> <span class="nc">GLibcLibrary</span> <span class="no">INSTANCE</span> <span class="o">=</span> <span class="nc">Native</span><span class="o">.</span><span class="na">loadLibrary</span><span class="o">(</span><span class="s">"libc.so.6"</span><span class="o">,</span> <span class="nc">GLibcLibrary</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

    <span class="cm">/**
      @see https://elixir.bootlin.com/glibc/glibc-2.17/source/malloc/malloc.c
      malloc_trim(size_t pad);

      If possible, gives memory back to the system (via negative
      arguments to sbrk) if there is unused memory at the `high' end of
      the malloc pool. You can call this after freeing large blocks of
      memory to potentially reduce the system-level memory requirements
      of a program. However, it cannot guarantee to reduce memory. Under
      some allocation patterns, some large free blocks of memory will be
      locked between two used chunks, so they cannot be given back to
      the system.

      The `pad' argument to malloc_trim represents the amount of free
      trailing space to leave untrimmed. If this argument is zero,
      only the minimum amount of memory to maintain internal data
      structures will be left (one page or less). Non-zero arguments
      can be supplied to maintain enough trailing space to service
      future expected allocations without having to re-obtain memory
      from the system.

      Malloc_trim returns 1 if it actually released any memory, else 0.
      On systems that do not support "negative sbrks", it will always
      return 0.
    */</span>
    <span class="kt">int</span> <span class="nf">malloc_trim</span><span class="o">(</span><span class="kt">int</span> <span class="n">size</span><span class="o">);</span>

    <span class="cm">/**
     * @see https://elixir.bootlin.com/glibc/glibc-2.17/source/malloc/malloc.c
     * struct mallinfo __libc_mallinfo(void);
     *
     * Returns (by copy) a struct containing various summary statistics
     */</span>
    <span class="nc">MallInfo</span><span class="o">.</span><span class="na">ByValue</span> <span class="nf">mallinfo</span><span class="o">();</span>
<span class="o">}</span>

<span class="cm">/**
 * 是 glibc malloc.h 中定义的 mallinfo struct 映射的 java 结构
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MallInfo</span> <span class="kd">extends</span> <span class="nc">Structure</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">ByValue</span> <span class="kd">extends</span> <span class="nc">MallInfo</span> <span class="kd">implements</span> <span class="nc">Structure</span><span class="o">.</span><span class="na">ByValue</span> <span class="o">{</span>

        <span class="kd">public</span> <span class="nf">ByValue</span><span class="o">()</span> <span class="o">{</span>
        <span class="o">}</span>

        <span class="kd">public</span> <span class="nc">String</span> <span class="nf">stats</span><span class="o">()</span> <span class="o">{</span>
            <span class="k">return</span> <span class="s">"===========================================================================\n"</span> <span class="o">+</span>
                    <span class="s">"Arena Total Size:                "</span> <span class="o">+</span> <span class="n">arena</span> <span class="o">/</span> <span class="mi">1024</span> <span class="o">+</span> <span class="s">" Kib\n"</span> <span class="o">+</span>
                    <span class="s">"Arena Used Size:                 "</span> <span class="o">+</span> <span class="n">uordblks</span> <span class="o">/</span> <span class="mi">1024</span> <span class="o">+</span> <span class="s">" Kib\n"</span> <span class="o">+</span>
                    <span class="s">"Arena Free Size:                 "</span> <span class="o">+</span> <span class="n">fordblks</span> <span class="o">/</span> <span class="mi">1024</span> <span class="o">+</span> <span class="s">" Kib\n"</span> <span class="o">+</span>
                    <span class="s">"Arena Reclaimable Size:          "</span> <span class="o">+</span> <span class="n">keepcost</span> <span class="o">/</span> <span class="mi">1024</span> <span class="o">+</span> <span class="s">" Kib\n"</span> <span class="o">+</span>
                    <span class="s">"Arena Free Blocks Count:         "</span> <span class="o">+</span> <span class="n">ordblks</span> <span class="o">+</span> <span class="s">"\n"</span> <span class="o">+</span>
                    <span class="s">"FastBin Blocks Count:            "</span> <span class="o">+</span> <span class="n">smblks</span> <span class="o">+</span> <span class="s">"\n"</span> <span class="o">+</span>
                    <span class="s">"FastBin Blocks Total Size :      "</span> <span class="o">+</span> <span class="n">fsmblks</span> <span class="o">/</span> <span class="mi">1024</span> <span class="o">+</span> <span class="s">"\n"</span> <span class="o">+</span>
                    <span class="s">"Mapped Blocks Count:             "</span> <span class="o">+</span> <span class="n">hblks</span> <span class="o">+</span> <span class="s">"\n"</span> <span class="o">+</span>
                    <span class="s">"Mapped Blocks Total Size:        "</span> <span class="o">+</span> <span class="n">hblkhd</span> <span class="o">/</span> <span class="mi">1024</span> <span class="o">+</span> <span class="s">" Kib\n"</span> <span class="o">+</span>
                    <span class="s">"Total C Heap Size:               "</span> <span class="o">+</span> <span class="o">(</span><span class="n">arena</span> <span class="o">/</span> <span class="mi">1024</span> <span class="o">+</span> <span class="n">hblkhd</span> <span class="o">/</span> <span class="mi">1024</span><span class="o">)</span> <span class="o">+</span> <span class="s">" Kib\n"</span> <span class="o">+</span>
                    <span class="s">"注: 因历史原因, mallinfo 中的指标都是int类型, 可能因数值越界而不不准确, 仅供参考"</span><span class="o">+</span>
                    <span class="s">"==========================================================================="</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="c1">// current total non-mmapped bytes allocated from system</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="n">arena</span><span class="o">;</span>

    <span class="c1">// the number of free chunks</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="n">ordblks</span><span class="o">;</span>  <span class="cm">/* number of free chunks */</span>

    <span class="c1">// the number of fastbin blocks (i.e., small chunks that have been freed but not use resused or consolidated)</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="n">smblks</span><span class="o">;</span>

    <span class="c1">// current number of mmapped regions</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="n">hblks</span><span class="o">;</span>

    <span class="c1">// total bytes held in mmapped regions</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="n">hblkhd</span><span class="o">;</span>

    <span class="c1">// the maximum total allocated space. This will be greater than current total if trimming has occurred.</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="n">usmblks</span><span class="o">;</span>

    <span class="c1">// total bytes held in fastbin blocks</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="n">fsmblks</span><span class="o">;</span>

    <span class="c1">// current total allocated space (normal or mmapped)</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="n">uordblks</span><span class="o">;</span>

    <span class="c1">// total free space</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="n">fordblks</span><span class="o">;</span>

    <span class="c1">// the maximum number of bytes that could ideally be released</span>
    <span class="c1">// back to system via malloc_trim. ("ideally" means that</span>
    <span class="c1">// it ignores page restrictions etc.)</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="n">keepcost</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">MallInfo</span><span class="o">()</span> <span class="o">{</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="nf">getFieldOrder</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nc">Lists</span><span class="o">.</span><span class="na">newArrayList</span><span class="o">(</span><span class="s">"arena"</span><span class="o">,</span> <span class="s">"ordblks"</span><span class="o">,</span> <span class="s">"smblks"</span><span class="o">,</span> <span class="s">"hblks"</span><span class="o">,</span> <span class="s">"hblkhd"</span><span class="o">,</span> <span class="s">"usmblks"</span><span class="o">,</span> <span class="s">"fsmblks"</span><span class="o">,</span> <span class="s">"uordblks"</span><span class="o">,</span> <span class="s">"fordblks"</span><span class="o">,</span> <span class="s">"keepcost"</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td>
</tr></tbody></table></code></div>
</div>
</div>
<div class="post-tail-wrapper text-muted">
<div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw me-1"></i> <a href="/categories/note/">Note</a>
</div>
<div class="post-tags"> <i class="fa fa-tags fa-fw me-1"></i> <a href="/tags/memory/" class="post-tag no-text-decoration">Memory</a> <a href="/tags/note/" class="post-tag no-text-decoration">note</a>
</div>
<div class=" post-tail-bottom d-flex justify-content-between align-items-center mt-5 pb-2 ">
<div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div>
<div class="share-wrapper d-flex align-items-center"> <span class="share-label text-muted">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=%E6%A8%A1%E5%9E%8B%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%86%85%E5%AD%98%E6%8C%81%E7%BB%AD%E4%B8%8B%E9%99%8D%E9%97%AE%E9%A2%98%E6%8E%92%E6%9F%A5%20-%2024601&url=https%3A%2F%2Flinbonanlibra.github.io%2Fposts%2F%25E5%25AE%25B9%25E5%2599%25A8%25E5%2586%2585%25E5%25AD%2598%25E6%258C%2581%25E7%25BB%25AD%25E5%25A2%259E%25E9%2595%25BF%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Twitter" aria-label="Twitter"> <i class="fa-fw fa-brands fa-square-x-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=%E6%A8%A1%E5%9E%8B%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%86%85%E5%AD%98%E6%8C%81%E7%BB%AD%E4%B8%8B%E9%99%8D%E9%97%AE%E9%A2%98%E6%8E%92%E6%9F%A5%20-%2024601&u=https%3A%2F%2Flinbonanlibra.github.io%2Fposts%2F%25E5%25AE%25B9%25E5%2599%25A8%25E5%2586%2585%25E5%25AD%2598%25E6%258C%2581%25E7%25BB%25AD%25E5%25A2%259E%25E9%2595%25BF%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Facebook" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https%3A%2F%2Flinbonanlibra.github.io%2Fposts%2F%25E5%25AE%25B9%25E5%2599%25A8%25E5%2586%2585%25E5%25AD%2598%25E6%258C%2581%25E7%25BB%25AD%25E5%25A2%259E%25E9%2595%25BF%2F&text=%E6%A8%A1%E5%9E%8B%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%86%85%E5%AD%98%E6%8C%81%E7%BB%AD%E4%B8%8B%E9%99%8D%E9%97%AE%E9%A2%98%E6%8E%92%E6%9F%A5%20-%2024601" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Telegram" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <button id="copy-link" aria-label="Copy link" class="btn small" data-bs-toggle="tooltip" data-bs-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> <i class="fa-fw fas fa-link pe-none fs-6"></i> </button> </span>
</div>
</div>
</div></article></main><aside aria-label="Panel" id="panel-wrapper" class="col-xl-3 ps-2 text-muted"><div class="access">
<section id="access-lastmod"><h2 class="panel-heading">Recently Updated</h2>
<ul class="content list-unstyled ps-0 pb-1 ms-1 mt-2">
<li class="text-truncate lh-lg"> <a href="/posts/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E5%9F%BA%E7%A1%80-%E7%AC%94%E8%AE%B0/">《大模型基础》阅读笔记</a>
</li>
<li class="text-truncate lh-lg"> <a href="/posts/%E5%AE%B9%E5%99%A8%E5%86%85%E5%AD%98%E6%8C%81%E7%BB%AD%E5%A2%9E%E9%95%BF/">模型服务器内存持续下降问题排查</a>
</li>
<li class="text-truncate lh-lg"> <a href="/posts/text-and-typography/">Text and Typography</a>
</li>
</ul></section><section><h2 class="panel-heading">Trending Tags</h2>
<div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/tags/note/">note</a> <a class="post-tag btn btn-outline-primary" href="/tags/ai/">AI</a> <a class="post-tag btn btn-outline-primary" href="/tags/memory/">Memory</a> <a class="post-tag btn btn-outline-primary" href="/tags/typography/">typography</a>
</div></section>
</div>
<div class="toc-border-cover z-3"></div>
<section id="toc-wrapper" class="invisible position-sticky ps-0 pe-4 pb-4"><h2 class="panel-heading ps-3 pb-2 mb-0">Contents</h2>
<nav id="toc"></nav></section></aside>
</div>
<div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 px-md-4">
<aside id="related-posts" aria-labelledby="related-label"><h3 class="mb-4" id="related-label">Further Reading</h3>
<nav class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-4 mb-4"><article class="col"> <a href="/posts/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E5%9F%BA%E7%A1%80-%E7%AC%94%E8%AE%B0/" class="post-preview card h-100"><div class="card-body"> <time data-ts="1760097480" data-df="ll"> Oct 10, 2025 </time><h4 class="pt-0 my-2">《大模型基础》阅读笔记</h4>
<div class="text-muted"><p>&gt; https://github.com/ZJU-LLMs/Foundations-of-LLMs ## 1.4 基于 Transformer 的语言模型 采样方法 1.4.1 概率最大化 - 贪心 在每轮预测中都选择概率最大的词。但当前概率大的词有可能导致后续的词概率都很小 - 波束搜索 每轮保留可能性大的 B 个，最后在 M 个集合里找联合概率最大的。不足是概率最大的...</p></div>
</div></a></article></nav></aside><nav class="post-navigation d-flex justify-content-between" aria-label="Post Navigation"> <a href="/posts/text-and-typography/" class="btn btn-outline-primary" aria-label="Older"><p>Text and Typography</p></a> <a href="/posts/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E5%9F%BA%E7%A1%80-%E7%AC%94%E8%AE%B0/" class="btn btn-outline-primary" aria-label="Newer"><p>《大模型基础》阅读笔记</p></a></nav><footer aria-label="Site Info" class=" d-flex flex-column justify-content-center text-muted flex-lg-row justify-content-lg-between align-items-lg-center pb-lg-3 "><p>© <time>2026</time> <a href="https://github.com/linbonanlibra">linbonanlibra</a>. <span data-bs-toggle="tooltip" data-bs-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p>
<p>Using the <a data-bs-toggle="tooltip" data-bs-placement="top" title="v7.4.1" href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme for <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a>.</p></footer>
</div></div>
<div id="search-result-wrapper" class="d-flex justify-content-center d-none"><div class="col-11 content">
<div id="search-hints"><section><h2 class="panel-heading">Trending Tags</h2>
<div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/tags/note/">note</a> <a class="post-tag btn btn-outline-primary" href="/tags/ai/">AI</a> <a class="post-tag btn btn-outline-primary" href="/tags/memory/">Memory</a> <a class="post-tag btn btn-outline-primary" href="/tags/typography/">typography</a>
</div></section></div>
<div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div>
</div></div>
</div>
<aside aria-label="Scroll to Top"> <button id="back-to-top" type="button" class="btn btn-lg btn-box-shadow"> <i class="fas fa-angle-up"></i> </button></aside>
</div>
<div id="mask" class="d-none position-fixed w-100 h-100 z-1"></div>
<aside id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-bs-animation="true" data-bs-autohide="false"><div class="toast-header"> <button type="button" class="btn-close ms-auto" data-bs-dismiss="toast" aria-label="Close"></button>
</div>
<div class="toast-body text-center pt-0">
<p class="px-2 mb-3">A new version of content is available.</p>
<button type="button" class="btn btn-primary" aria-label="Update"> Update </button>
</div></aside><script> document.addEventListener('DOMContentLoaded', () => { SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<article class="px-1 px-sm-2 px-lg-4 px-xl-0"><header><h2><a href="{url}">{title}</a></h2><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div></header><p>{content}</p></article>', noResultsText: '<p class="mt-5">Oops! No results found.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="me-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); }); </script>
</body>
</html>
